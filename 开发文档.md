# ğŸ—‚ å¤©ä½¿æ”¯ä»˜ç³»ç»Ÿå¼€å‘æ–‡æ¡£

> **å¼€å‘æ–‡æ¡£çš„æ ¸å¿ƒç›®æ ‡ï¼š**
> 
> 1. çŸ¥è¯†ä¼ é€’ - æ–°äººçœ‹æ–‡æ¡£å°±èƒ½å¿«é€Ÿç†è§£ç³»ç»Ÿå’Œä¸Šæ‰‹å¼€å‘
> 2. è§„èŒƒç»Ÿä¸€ - ç»Ÿä¸€æ ¼å¼å’Œç»“æ„ï¼Œæé«˜å›¢é˜Ÿåä½œæ•ˆç‡
> 3. é™ä½äº¤æ¥æˆæœ¬ - äººå‘˜å˜åŠ¨æ—¶å‡å°‘ä¾èµ–ï¼Œå®ç°å¿«é€Ÿäº¤æ¥
> 4. æ‰“é€šåä½œé“¾è·¯ - å¼€å‘ã€è¿ç»´ã€æµ‹è¯•å…±äº«ä¿¡æ¯ï¼Œé¿å…å­¤å²›
> 5. å¯è¿½æº¯å®¡è®¡ - è®°å½•å˜æ›´å†å²ï¼Œä¾¿äºé—®é¢˜å›æº¯

---

## 0. æ–‡æ¡£æ§åˆ¶

| å­—æ®µ | å†…å®¹ | è¯´æ˜ |
| --- | --- | --- |
| æ–‡æ¡£ç¼–å· | DEV-TIANSHIPAY-STD | ç»Ÿä¸€ç¼–å·ï¼Œ`DEV-ç³»ç»Ÿ-ç±»å‹` |
| ç‰ˆæœ¬ | v1.0 | è¯­ä¹‰åŒ–ç‰ˆæœ¬ |
| ç”Ÿæ•ˆæ—¥æœŸ | 2025-01-27 | æ‰¹å‡†åç”Ÿæ•ˆ |
| å®¡æ‰¹äºº(Approver) | æŠ€æœ¯è´Ÿè´£äºº | æœ‰å‘å¸ƒ/æ ‡å‡†æ‰¹å‡†æƒ |
| å¤å®¡å‘¨æœŸ | æ¯ 6 ä¸ªæœˆ | åˆ°æœŸå¿…é¡»å¤å®¡ |
| æ–‡æ¡£å¯†çº§ | å†…éƒ¨/å—é™ | è®¿é—®èŒƒå›´ |
| è®°å½•ä¿å­˜å¹´é™ | â‰¥ 3 å¹´ | ç‰ˆæœ¬ä¸è¯„å®¡è®°å½•ä¿ç•™ |

## 1. åŸºæœ¬ä¿¡æ¯

| å­—æ®µ | å†…å®¹ | å¡«å†™æŒ‡å¼• |
| --- | --- | --- |
| **ç³»ç»Ÿåç§°** | å¤©ä½¿æ”¯ä»˜ç³»ç»Ÿï¼ˆTianShiPayï¼‰ | ç³»ç»Ÿå…¨ç§° + å¸¸ç”¨ç®€ç§° |
| **ç³»ç»Ÿ ID** | SYS-PAY-001 | å…¬å¸å”¯ä¸€ç¼–å·ï¼Œä¾‹å¦‚ `SYS-éƒ¨é—¨ç¼©å†™-åºå·` |
| **è´Ÿè´£äººï¼ˆOwnerï¼‰** | æŠ€æœ¯è´Ÿè´£äºº | æŠ€æœ¯è´Ÿè´£äººï¼Œè´Ÿè´£å¼€å‘æ–‡æ¡£æ›´æ–° |
| **å¤‡ä»½äººï¼ˆBackupï¼‰** | è¿ç»´è´Ÿè´£äºº | è´Ÿè´£äººçš„æ›¿è¡¥ |
| **ä»£ç ä»“åº“** | `git@github.com:aaachuge/newtianshizhifupay.git` | GitHub/GitLab ä»“åº“åœ°å€ |
| **æ–‡æ¡£æœ€åæ›´æ–°** | 2025-01-27 | æ–‡æ¡£å®é™…ä¿®æ”¹æ—¥æœŸ |

---

## 2. ç³»ç»Ÿæ¦‚è¿°

| é¡¹ç›® | å†…å®¹ | å¡«å†™æŒ‡å¼• |
| --- | --- | --- |
| **ä¸€å¥è¯ç®€ä»‹** | å¤©ä½¿æ”¯ä»˜æ˜¯ä¸€ä¸ªå…ç­¾çº¦æ”¯ä»˜å¹³å°ï¼Œæ”¯æŒæ”¯ä»˜å®ã€å¾®ä¿¡ã€QQé’±åŒ…ç­‰å¤šç§æ”¯ä»˜æ–¹å¼ï¼Œä¸ºå•†æˆ·æä¾›ä¸€ç«™å¼æ”¯ä»˜è§£å†³æ–¹æ¡ˆã€‚ | ç”¨ 1-2 å¥è¯æ¦‚è¿°ç³»ç»Ÿä½œç”¨ |
| **ä¸»è¦åŠŸèƒ½** | - å¤šæ”¯ä»˜æ–¹å¼é›†æˆï¼ˆæ”¯ä»˜å®/å¾®ä¿¡/QQé’±åŒ…ï¼‰- å•†æˆ·ç®¡ç†ç³»ç»Ÿ- è®¢å•ç®¡ç†ä¸ç»“ç®—- æ”¯ä»˜é€šé“ç®¡ç†- é£é™©æ§åˆ¶ä¸ç›‘æ§ | åˆ—å‡º 3~5 ä¸ªä¸»è¦åŠŸèƒ½ |
| **æ ¸å¿ƒäº®ç‚¹ / æŠ€æœ¯ç‰¹æ€§** | å…ç­¾çº¦æ”¯ä»˜ã€å¤šé€šé“è½®è¯¢ã€å®æ—¶ç»“ç®—ã€é£é™©æ§åˆ¶ | å¯é€‰ï¼Œçªå‡ºä¸å…¶ä»–ç³»ç»Ÿçš„åŒºåˆ« |

---

## 3. ç³»ç»Ÿæ¶æ„ï¼ˆè½åœ°ç‰ˆï¼‰

### 3.1 ç³»ç»Ÿç»„æˆä¸äº¤äº’

```mermaid
flowchart LR
  subgraph Client[å®¢æˆ·ç«¯]
    A1[Web æµè§ˆå™¨]
    A2[ç§»åŠ¨ç«¯ H5]
    A3[API è°ƒç”¨]
  end

  subgraph AppServer[åº”ç”¨æœåŠ¡]
    B1[æ”¯ä»˜æ¥å£å±‚]
    B2[å•†æˆ·ç®¡ç†]
    B3[è®¢å•å¤„ç†]
    B4[ç»“ç®—ç³»ç»Ÿ]
  end

  subgraph Infra[åŸºç¡€æœåŠ¡]
    C1[(MySQL æ•°æ®åº“)]
    C2[æ”¯ä»˜é€šé“]
    C3[é€šçŸ¥æœåŠ¡]
    C4[æ—¥å¿—ç³»ç»Ÿ]
  end

  Client --> B1
  B1 --> B2
  B1 --> B3
  B2 --> C1
  B3 --> C1
  B3 --> C2
  B4 --> C1
  B4 --> C3
  B1 --> C4
```

**è¯´æ˜ï¼š**

- **æ”¯ä»˜æ¥å£å±‚**ï¼šç»Ÿä¸€æ¥æ”¶æ”¯ä»˜è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒã€ç­¾åéªŒè¯
- **å•†æˆ·ç®¡ç†**ï¼šå•†æˆ·æ³¨å†Œã€è®¤è¯ã€æƒé™ç®¡ç†
- **è®¢å•å¤„ç†**ï¼šè®¢å•åˆ›å»ºã€çŠ¶æ€æ›´æ–°ã€æ”¯ä»˜å¤„ç†
- **ç»“ç®—ç³»ç»Ÿ**ï¼šè‡ªåŠ¨ç»“ç®—ã€æ‰‹åŠ¨ç»“ç®—ã€èµ„é‡‘ç®¡ç†
- **åŸºç¡€æœåŠ¡**ï¼šæ•°æ®åº“ã€æ”¯ä»˜é€šé“ã€é€šçŸ¥ã€æ—¥å¿—

---

### 3.2 æ¨¡å—è¯´æ˜è¡¨

> ç”¨äºå¿«é€Ÿå®šä½åŠŸèƒ½ â†’ ç›®å½• â†’ æ–‡ä»¶

| æ¨¡å— | åŠŸèƒ½è¯´æ˜ | ä¸»è¦ç›®å½• | å…³é”®å…¥å£æ–‡ä»¶/ç±» | å¤‡æ³¨ |
| --- | --- | --- | --- | --- |
| **æ’ä»¶æ¨¡å—** | **ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨é€»è¾‘** | `/plugins` | å„æ”¯ä»˜æ’ä»¶ç›®å½• | **ç³»ç»Ÿæ ¸å¿ƒï¼ŒåŒ…å«199ä¸ªæ”¯ä»˜æ’ä»¶** |
| æ”¯ä»˜æ¨¡å— | æ”¯ä»˜æ¥å£ã€è®¢å•å¤„ç† | `/` | `submit.php` / `pay.php` | æ ¸å¿ƒæ”¯ä»˜é€»è¾‘ |
| å•†æˆ·æ¨¡å— | å•†æˆ·ç®¡ç†ã€è®¤è¯ | `/admin` | `shanghu.php` / `ulist.php` | å•†æˆ·æƒé™æ§åˆ¶ |
| è®¢å•æ¨¡å— | è®¢å•æŸ¥è¯¢ã€ç»Ÿè®¡ | `/admin` | `order.php` / `record.php` | è®¢å•çŠ¶æ€ç®¡ç† |
| ç»“ç®—æ¨¡å— | èµ„é‡‘ç»“ç®—ã€è½¬è´¦ | `/admin` | `settle.php` / `transfer_*.php` | èµ„é‡‘å®‰å…¨ |
| é€šé“æ¨¡å— | æ”¯ä»˜é€šé“ç®¡ç† | `/admin` | `pay_channel.php` / `pay_type.php` | é€šé“é…ç½® |
| æ¨¡æ¿æ¨¡å— | å‰ç«¯æ¨¡æ¿ | `/template` | å„æ¨¡æ¿ç›®å½• | ç”¨æˆ·ç•Œé¢ |

---

### 3.3 å…¥å£ç´¢å¼•ï¼ˆTop 10 å¸¸æ”¹åŠŸèƒ½ï¼‰

> ç”¨äºå¿«é€Ÿå®šä½åˆ°å…·ä½“æ–¹æ³•/è·¯ç”±ï¼Œå»ºè®®ç”± Swagger/è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ

| åŠŸèƒ½ | è·¯ç”±/æ–¹æ³• | æ–‡ä»¶ä½ç½® | å¤‡æ³¨ |
| --- | --- | --- | --- |
| **æ’ä»¶ç®¡ç†** | `GET /admin/pay_plugin.php` â†’ `updateAll()` | `/admin/pay_plugin.php:15` | **åˆ·æ–°199ä¸ªæ”¯ä»˜æ’ä»¶åˆ—è¡¨** |
| **ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨** | `GET /pay/{plugin}/submit/{trade_no}` | `/plugins/{plugin}/submit.php` | **çœŸå®æ”¯ä»˜é€»è¾‘ï¼Œå¦‚tmã€emoç­‰** |
| **æ”¯ä»˜å›è°ƒå¤„ç†** | `POST /pay/{plugin}/notify/{trade_no}` | `/plugins/{plugin}/notify.php` | **å¼‚æ­¥é€šçŸ¥å¤„ç†** |
| **æ”¯ä»˜é¡µé¢å±•ç¤º** | `GET /pay/{plugin}/qrcode/{trade_no}` | `/plugins/{plugin}/qrcode.php` | **äºŒç»´ç /æ”¯ä»˜é¡µé¢** |
| åˆ›å»ºæ”¯ä»˜è®¢å• | `POST /submit.php` â†’ `submit()` | `/submit.php:72` | æ ¸å¿ƒæ”¯ä»˜æ¥å£ |
| æ”¯ä»˜å¤„ç† | `GET /pay.php` â†’ `pay()` | `/pay.php:8` | æ”¯ä»˜é¡µé¢è·³è½¬ |
| å•†æˆ·æ³¨å†Œ | `POST /api.php?act=apply` â†’ `apply()` | `/api.php:13` | å•†æˆ·ç”³è¯·æ¥å£ |
| è®¢å•æŸ¥è¯¢ | `GET /api.php?act=order` â†’ `order()` | `/api.php:112` | è®¢å•çŠ¶æ€æŸ¥è¯¢ |
| ç»“ç®—ç”³è¯· | `POST /admin/settle.php` â†’ `settle()` | `/admin/settle.php` | èµ„é‡‘ç»“ç®— |
| é€šé“é…ç½® | `POST /admin/pay_channel.php` â†’ `config()` | `/admin/pay_channel.php` | æ”¯ä»˜é€šé“è®¾ç½® |

---

### 3.4 ä¸»æµç¨‹ï¼ˆæœ€å¸¸ç”¨ç”¨æˆ·è·¯å¾„ï¼‰

ç”¨ä¸€å¼ å›¾å±•ç¤ºç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œå¸®åŠ©æ–°äººå¿«é€Ÿç†è§£åŠŸèƒ½è¿è¡Œé¡ºåºï¼Œå¹¶å®šä½åˆ°ç›¸å…³ä»£ç æ¨¡å—

```mermaid
sequenceDiagram
  participant M as å•†æˆ·(Merchant)
  participant S as æ”¯ä»˜æ¥å£(Submit)
  participant P as æ”¯ä»˜å¤„ç†(Pay)
  participant PL as æ”¯ä»˜æ’ä»¶(Plugin)
  participant API as ç¬¬ä¸‰æ–¹API
  participant N as é€šçŸ¥æœåŠ¡(Notify)
  participant DB as æ•°æ®åº“(Database)

  M->>S: æäº¤æ”¯ä»˜è¯·æ±‚ (POST /submit.php)
  S->>S: å‚æ•°æ ¡éªŒã€ç­¾åéªŒè¯
  S->>DB: åˆ›å»ºè®¢å•è®°å½•
  S->>P: è·³è½¬æ”¯ä»˜é¡µé¢ (GET /pay.php)
  P->>PL: é€‰æ‹©æ”¯ä»˜æ’ä»¶ (å¦‚tmã€emoç­‰)
  PL->>API: è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜API
  API->>PL: è¿”å›æ”¯ä»˜é“¾æ¥/äºŒç»´ç 
  PL->>M: å±•ç¤ºæ”¯ä»˜é¡µé¢
  
  Note over M,API: ç”¨æˆ·å®Œæˆæ”¯ä»˜
  
  API->>PL: æ”¯ä»˜ç»“æœå›è°ƒ (POST /notify.php)
  PL->>DB: æ›´æ–°è®¢å•çŠ¶æ€
  PL->>N: å¼‚æ­¥é€šçŸ¥å•†æˆ·
  N->>M: åŒæ­¥è·³è½¬å•†æˆ·é¡µé¢
```

---

**é˜…è¯»è¯´æ˜ï¼š**

- **Mï¼ˆå•†æˆ· Merchantï¼‰** â†’ å‘èµ·æ”¯ä»˜è¯·æ±‚æˆ–æ¥æ”¶é€šçŸ¥
- **Sï¼ˆæ”¯ä»˜æ¥å£ Submitï¼‰** â†’ æ¥æ”¶æ”¯ä»˜å‚æ•°ï¼Œåšæ ¡éªŒå’Œè½¬å‘
- **Pï¼ˆæ”¯ä»˜å¤„ç† Payï¼‰** â†’ æ”¯ä»˜é¡µé¢å±•ç¤ºå’Œæ’ä»¶é€‰æ‹©
- **PLï¼ˆæ”¯ä»˜æ’ä»¶ Pluginï¼‰** â†’ **æ ¸å¿ƒï¼š199ä¸ªç¬¬ä¸‰æ–¹æ”¯ä»˜æ’ä»¶ï¼ŒçœŸå®æ”¯ä»˜é€»è¾‘**
- **APIï¼ˆç¬¬ä¸‰æ–¹APIï¼‰** â†’ æ”¯ä»˜å®ã€å¾®ä¿¡ã€QQé’±åŒ…ç­‰çœŸå®æ”¯ä»˜æ¥å£
- **Nï¼ˆé€šçŸ¥æœåŠ¡ Notifyï¼‰** â†’ å¤„ç†æ”¯ä»˜ç»“æœé€šçŸ¥
- **DBï¼ˆæ•°æ®åº“ Databaseï¼‰** â†’ å­˜å‚¨è®¢å•å’Œç”¨æˆ·æ•°æ®

---

## 4. æŠ€æœ¯æ ˆ

| ç»„ä»¶ | ç‰ˆæœ¬ | ç”¨é€” | å¡«å†™æç¤º |
| --- | --- | --- | --- |
| PHP | 7.4+ | åº”ç”¨æœåŠ¡ | ä¸»å¼€å‘è¯­è¨€ä¸æ¡†æ¶ |
| MySQL | 5.7+ | æ•°æ®å­˜å‚¨ | æ•°æ®åº“ç±»å‹ |
| Apache/Nginx | 2.4+ | WebæœåŠ¡å™¨ | WebæœåŠ¡å™¨ |
| Bootstrap | 3.x | å‰ç«¯æ¡†æ¶ | UIç»„ä»¶åº“ |
| jQuery | 1.x | å‰ç«¯äº¤äº’ | JavaScriptåº“ |
|  |  |  |  |

---

### 4.1 ç¬¬ä¸‰æ–¹ä¾èµ–ä¸è®¸å¯

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” | è®¸å¯ | é£é™©/æ›¿ä»£ |
| --- | --- | --- | --- | --- |
| æ”¯ä»˜å®SDK | æœ€æ–° | æ”¯ä»˜å®æ”¯ä»˜ | å•†ä¸šè®¸å¯ | éœ€ç”³è¯·å•†æˆ·å· |
| å¾®ä¿¡æ”¯ä»˜SDK | æœ€æ–° | å¾®ä¿¡æ”¯ä»˜ | å•†ä¸šè®¸å¯ | éœ€ç”³è¯·å•†æˆ·å· |
| QQé’±åŒ…SDK | æœ€æ–° | QQé’±åŒ…æ”¯ä»˜ | å•†ä¸šè®¸å¯ | éœ€ç”³è¯·å•†æˆ·å· |

## 5. å¼€å‘ç¯å¢ƒæ­å»º

> è¯¦è§ï¼šã€Šåº”ç”¨éƒ¨ç½²è¯´æ˜ - å¤©ä½¿æ”¯ä»˜ã€‹æ–‡æ¡£

### 5.1 ç¯å¢ƒè¦æ±‚
- PHP 7.4+
- MySQL 5.7+
- Apache/Nginx
- æ”¯æŒURLé‡å†™

### 5.2 å®‰è£…æ­¥éª¤
1. ä¸‹è½½æºç åˆ°Webç›®å½•
2. é…ç½®æ•°æ®åº“è¿æ¥ï¼ˆconfig.phpï¼‰
3. è®¿é—® `/install/` è¿›è¡Œå®‰è£…
4. é…ç½®ä¼ªé™æ€è§„åˆ™
5. é…ç½®æ”¯ä»˜é€šé“

---

## 6. æ¥å£æ–‡æ¡£ï¼ˆæ ¸å¿ƒç¤ºä¾‹ï¼‰

### 6.1 æ”¯ä»˜æ¥å£

**æ¥å£åœ°å€ï¼š** `POST /submit.php`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "pid": "å•†æˆ·ID",
  "type": "æ”¯ä»˜æ–¹å¼",
  "out_trade_no": "å•†æˆ·è®¢å•å·",
  "notify_url": "å¼‚æ­¥é€šçŸ¥åœ°å€",
  "return_url": "åŒæ­¥è·³è½¬åœ°å€",
  "name": "å•†å“åç§°",
  "money": "æ”¯ä»˜é‡‘é¢",
  "sign": "ç­¾å"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "pay_url": "æ”¯ä»˜é¡µé¢URL"
}
```

### 6.2 æ’ä»¶ç®¡ç†æ¥å£

**æ¥å£åœ°å€ï¼š** `GET /admin/pay_plugin.php?my=refresh`

**åŠŸèƒ½è¯´æ˜ï¼š** åˆ·æ–°199ä¸ªæ”¯ä»˜æ’ä»¶åˆ—è¡¨ï¼Œæ‰«æ `/plugins` ç›®å½•ä¸‹çš„æ‰€æœ‰æ’ä»¶

**æ’ä»¶ç»“æ„ï¼š**
```
/plugins/{plugin_name}/
â”œâ”€â”€ config.ini          # æ’ä»¶é…ç½®æ–‡ä»¶
â”œâ”€â”€ submit.php          # æ”¯ä»˜æäº¤é€»è¾‘
â”œâ”€â”€ notify.php          # å¼‚æ­¥å›è°ƒå¤„ç†
â”œâ”€â”€ qrcode.php          # æ”¯ä»˜é¡µé¢å±•ç¤º
â”œâ”€â”€ return.php          # åŒæ­¥è·³è½¬å¤„ç†
â””â”€â”€ pay/                # æ”¯ä»˜ç›¸å…³ç±»åº“
    â”œâ”€â”€ config.php
    â”œâ”€â”€ Http.php
    â””â”€â”€ ...
```

### 6.3 ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨

**æ¥å£åœ°å€ï¼š** `GET /pay/{plugin}/submit/{trade_no}`

**åŠŸèƒ½è¯´æ˜ï¼š** è°ƒç”¨å…·ä½“æ”¯ä»˜æ’ä»¶çš„æäº¤é€»è¾‘

**ç¤ºä¾‹ï¼š**
- `/pay/tm/submit/20250127123456/` â†’ è°ƒç”¨TMæ”¯ä»˜æ’ä»¶
- `/pay/emo/submit/20250127123456/` â†’ è°ƒç”¨æ¶é­”æ”¯ä»˜æ’ä»¶

### 6.4 æ”¯ä»˜å›è°ƒå¤„ç†

**æ¥å£åœ°å€ï¼š** `POST /pay/{plugin}/notify/{trade_no}`

**åŠŸèƒ½è¯´æ˜ï¼š** å¤„ç†ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„å¼‚æ­¥é€šçŸ¥

### 6.5 è®¢å•æŸ¥è¯¢æ¥å£

**æ¥å£åœ°å€ï¼š** `GET /api.php?act=order`

**è¯·æ±‚å‚æ•°ï¼š**
- `pid`: å•†æˆ·ID
- `key`: å•†æˆ·å¯†é’¥
- `trade_no`: ç³»ç»Ÿè®¢å•å·ï¼ˆå¯é€‰ï¼‰
- `out_trade_no`: å•†æˆ·è®¢å•å·ï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 1,
  "trade_no": "ç³»ç»Ÿè®¢å•å·",
  "out_trade_no": "å•†æˆ·è®¢å•å·",
  "status": "è®¢å•çŠ¶æ€",
  "money": "æ”¯ä»˜é‡‘é¢"
}
```

---

## 7. æ•°æ®åº“ç»“æ„ï¼ˆæ ¸å¿ƒè¡¨ï¼‰

### 7.1 æ ¸å¿ƒè¡¨å­—æ®µè§£æ

| è¡¨å | å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- | --- |
| pay_user | **uid** | INT | å•†æˆ·IDï¼Œä¸»é”® |
|  | **username** | VARCHAR(50) | å•†æˆ·ç”¨æˆ·å |
|  | **key** | VARCHAR(32) | å•†æˆ·å¯†é’¥ |
|  | **status** | TINYINT | å•†æˆ·çŠ¶æ€ï¼ˆ0=ç¦ç”¨ï¼Œ1=å¯ç”¨ï¼‰ |
|  | **money** | DECIMAL(10,2) | è´¦æˆ·ä½™é¢ |
|  | **settle** | TINYINT | ç»“ç®—çŠ¶æ€ |
| pay_order | **trade_no** | VARCHAR(32) | ç³»ç»Ÿè®¢å•å·ï¼Œä¸»é”® |
|  | **out_trade_no** | VARCHAR(32) | å•†æˆ·è®¢å•å· |
|  | **uid** | INT | å•†æˆ·ID |
|  | **money** | DECIMAL(10,2) | æ”¯ä»˜é‡‘é¢ |
|  | **status** | TINYINT | è®¢å•çŠ¶æ€ï¼ˆ0=å¾…æ”¯ä»˜ï¼Œ1=å·²æ”¯ä»˜ï¼‰ |
|  | **addtime** | DATETIME | åˆ›å»ºæ—¶é—´ |
|  | **endtime** | DATETIME | å®Œæˆæ—¶é—´ |
| pay_channel | **id** | INT | é€šé“IDï¼Œä¸»é”® |
|  | **name** | VARCHAR(50) | é€šé“åç§° |
|  | **plugin** | VARCHAR(50) | æ”¯ä»˜æ’ä»¶ |
|  | **rate** | DECIMAL(5,2) | é€šé“è´¹ç‡ |
|  | **status** | TINYINT | é€šé“çŠ¶æ€ |

### 7.2 ç´¢å¼•ä¸çº¦æŸï¼ˆæœ€å°å¿…è¦é›†ï¼‰

| åç§° | ç±»å‹ | å®šä¹‰ | ä½œç”¨ |
| --- | --- | --- | --- |
| **idx_uid** | INDEX | `(uid)` | å•†æˆ·æŸ¥è¯¢ |
| **idx_trade_no** | UNIQUE | `(trade_no)` | è®¢å•å·å”¯ä¸€ |
| **idx_out_trade_no** | INDEX | `(out_trade_no)` | å•†æˆ·è®¢å•å·æŸ¥è¯¢ |
| **idx_status_time** | INDEX | `(status, addtime)` | æŒ‰çŠ¶æ€å’Œæ—¶é—´æŸ¥è¯¢ |
| **idx_uid_status** | INDEX | `(uid, status)` | å•†æˆ·è®¢å•çŠ¶æ€æŸ¥è¯¢ |

---

### 7.3 DDL æ¨¡æ¿ï¼ˆæ ¸å¿ƒè¡¨ï¼‰

```sql
-- å•†æˆ·è¡¨
CREATE TABLE `pay_user` (
  `uid` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `key` varchar(32) NOT NULL,
  `status` tinyint(1) NOT NULL DEFAULT '1',
  `money` decimal(10,2) NOT NULL DEFAULT '0.00',
  `settle` tinyint(1) NOT NULL DEFAULT '1',
  `addtime` datetime NOT NULL,
  PRIMARY KEY (`uid`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- è®¢å•è¡¨
CREATE TABLE `pay_order` (
  `trade_no` varchar(32) NOT NULL,
  `out_trade_no` varchar(32) NOT NULL,
  `uid` int(11) NOT NULL,
  `money` decimal(10,2) NOT NULL,
  `status` tinyint(1) NOT NULL DEFAULT '0',
  `addtime` datetime NOT NULL,
  `endtime` datetime DEFAULT NULL,
  PRIMARY KEY (`trade_no`),
  KEY `idx_uid` (`uid`),
  KEY `idx_out_trade_no` (`out_trade_no`),
  KEY `idx_status_time` (`status`, `addtime`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- æ”¯ä»˜é€šé“è¡¨
CREATE TABLE `pay_channel` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `plugin` varchar(50) NOT NULL,
  `rate` decimal(5,2) NOT NULL DEFAULT '0.00',
  `status` tinyint(1) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

---

### 7.4 30 ç§’å‹¾é€‰ï¼ˆä¸Šçº¿å‰ï¼‰

- [ ] å•†æˆ·å¯†é’¥ï¼ˆkeyï¼‰å¿…é¡»å”¯ä¸€ä¸”å®‰å…¨
- [ ] è®¢å•å·ï¼ˆtrade_noï¼‰å¿…é¡»å”¯ä¸€
- [ ] é‡‘é¢å­—æ®µä½¿ç”¨ DECIMAL ç±»å‹
- [ ] æ—¶é—´å­—æ®µç»Ÿä¸€ä½¿ç”¨ DATETIME
- [ ] çŠ¶æ€å­—æ®µä½¿ç”¨ TINYINT
- [ ] æ‰€æœ‰è¡¨éƒ½æœ‰é€‚å½“çš„ç´¢å¼•

---

## 8. ä¸šåŠ¡è§„åˆ™

---

| **è§„åˆ™æè¿°** | **è¯´æ˜** | **è§¦å‘æ¡ä»¶ / å¤‡æ³¨** |
| --- | --- | --- |
| æ”¯ä»˜é‡‘é¢é™åˆ¶ | å•ç¬”æ”¯ä»˜é‡‘é¢å¿…é¡»åœ¨ç³»ç»Ÿè®¾å®šçš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´ | åœ¨ submit.php ä¸­æ ¡éªŒ |
| è®¢å•å·å”¯ä¸€æ€§ | å•†æˆ·è®¢å•å·ï¼ˆout_trade_noï¼‰åœ¨åŒä¸€å•†æˆ·ä¸‹å¿…é¡»å”¯ä¸€ | åˆ›å»ºè®¢å•æ—¶æ£€æŸ¥ |
| ç­¾åéªŒè¯ | æ‰€æœ‰APIè¯·æ±‚å¿…é¡»é€šè¿‡ç­¾åéªŒè¯ | ä½¿ç”¨å•†æˆ·å¯†é’¥è¿›è¡ŒMD5ç­¾å |
| å¼‚æ­¥é€šçŸ¥ | æ”¯ä»˜æˆåŠŸåå¿…é¡»å‘é€å¼‚æ­¥é€šçŸ¥ç»™å•†æˆ· | æœ€å¤šé‡è¯•5æ¬¡ï¼Œé—´éš”é€’å¢ |
| ç»“ç®—è§„åˆ™ | å•†æˆ·å¯è®¾ç½®è‡ªåŠ¨ç»“ç®—æˆ–æ‰‹åŠ¨ç»“ç®— | ç»“ç®—é‡‘é¢å¿…é¡»å¤§äºæœ€å°ç»“ç®—é‡‘é¢ |
| é£é™©æ§åˆ¶ | ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¼‚å¸¸è®¢å•å’Œé£é™©å•†æˆ· | åŸºäºIPã€é‡‘é¢ã€é¢‘ç‡ç­‰ç»´åº¦ |

---

**ä½¿ç”¨è¯´æ˜**

1. **è§„åˆ™æè¿°**ï¼šç”¨åŠ¨è¯æˆ–åè¯çŸ­è¯­å¼€å¤´ï¼Œç®€æ˜æè¿°è§„åˆ™æ ¸å¿ƒã€‚
2. **è¯´æ˜**ï¼šæ˜ç¡®è§„åˆ™å…·ä½“åšæ³•æˆ–æ•°æ®æ¥æºã€‚
3. **è§¦å‘æ¡ä»¶/å¤‡æ³¨**ï¼ˆå¯é€‰ï¼‰ï¼šå†™æ¸…æ¥šè§„åˆ™ç”Ÿæ•ˆçš„å‰ææ¡ä»¶ã€ç‰¹æ®Šæƒ…å†µæˆ–é…ç½®å…¥å£ã€‚

---

## 9. æµ‹è¯•ä¸è´¨é‡

| é¡¹ç›® | å†…å®¹ | å¡«å†™æç¤º |
| --- | --- | --- |
| æµ‹è¯•ç¯å¢ƒåœ°å€ | [http://test.tianshipay.com](http://test.tianshipay.com/) | æµ‹è¯•æœåŠ¡å™¨è®¿é—®åœ°å€ |
| è‡ªåŠ¨åŒ–æµ‹è¯• | `/tests` ç›®å½• | æµ‹è¯•ä»£ç ä½ç½® |
| æµ‹è¯•è´¦å· | `test001` / `123456` | æµ‹è¯•ç”¨ä¾‹è´¦å· |
| å›å½’æµ‹è¯• checklist | [æµ‹è¯•æ–‡æ¡£é“¾æ¥](#) | å›å½’æµ‹è¯•æ­¥éª¤æˆ–æ¸…å•é“¾æ¥ |

---

## 10. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ | è´Ÿè´£äºº |
| --- | --- | --- | --- |
| v1.0 | 2025-01-27 | åˆå§‹ç‰ˆæœ¬ä¸Šçº¿ | æŠ€æœ¯è´Ÿè´£äºº |
| v1.1 | 2025-02-01 | å¢åŠ å¾®ä¿¡æ”¯ä»˜ | å¼€å‘å›¢é˜Ÿ |
| v1.2 | 2025-02-15 | å¢åŠ é£é™©æ§åˆ¶ | å¼€å‘å›¢é˜Ÿ |

---

## 11. å…³è”èµ„æº

| èµ„æºç±»å‹ | é“¾æ¥ | å¡«å†™æç¤º |
| --- | --- | --- |
| éœ€æ±‚æ–‡æ¡£ | [é“¾æ¥](#) | ç³»ç»Ÿéœ€æ±‚è¯´æ˜ä¹¦ |
| UI è®¾è®¡ç¨¿ | [é“¾æ¥](#) | åŸå‹/è®¾è®¡å›¾ |
| éƒ¨ç½²æ–‡æ¡£ | [é“¾æ¥](#) | å¯¹åº” Deployment Guide |
| åº”æ€¥æ‰‹å†Œ | [é“¾æ¥](#) | å¯¹åº” Runbook |

---

## 12. å®‰å…¨ä¸åˆè§„

| **é¡¹ç›®** | **è¦æ±‚/æªæ–½** | **è¯´æ˜** |
| --- | --- | --- |
| å¸¸è§é£é™©é˜²æŠ¤ | SQL æ³¨å…¥ã€è¶Šæƒè®¿é—®ã€XSSæ”»å‡» | å¿…é¡»åšå‚æ•°æ ¡éªŒã€æƒé™æ£€æŸ¥ã€è¾“å…¥è¿‡æ»¤ |
| å®‰å…¨å®è·µ | ä»£ç å®¡æŸ¥ã€ä¾èµ–åº“æ‰«æ | å‘ç°æ¼æ´ç«‹å³ä¿®å¤ |
| æ—¥å¿—å®¡è®¡ | æ”¯ä»˜æ“ä½œã€èµ„é‡‘å˜åŠ¨å†™å…¥ `pay_log` | æ—¥å¿—ä¸­æ•æ„Ÿå­—æ®µéœ€è„±æ• |
| æ•°æ®åˆ†çº§ | æ”¯ä»˜é‡‘é¢=æ•æ„Ÿè´¢åŠ¡ä¿¡æ¯ | æ—¥å¿—ä¸è®°å½•å®Œæ•´é‡‘é¢ |
| æƒé™çŸ©é˜µ | Merchant / Admin / SuperAdmin | ä¸¥æ ¼æŒ‰è§’è‰²åˆ†é…æƒé™ |
| åŠ å¯†å­˜å‚¨ | MD5+ç›å€¼ | ç”¨äºå¯†ç å’Œç­¾å |
| åˆè§„è¦æ±‚ | æ”¯ä»˜è¡Œä¸šè§„èŒƒã€åæ´—é’± | å¿…é¡»éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ |
| è®¤è¯æœºåˆ¶ | ç­¾åéªŒè¯ | åœ¨æ‰€æœ‰æ”¯ä»˜ç›¸å…³æ¥å£ä¸­å¿…é¡»æ ¡éªŒç­¾å |

## 13. å¸¸è§é—®é¢˜ & æ•…éšœæ’æŸ¥

å·²çŸ¥é—®é¢˜/å‘

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
| --- | --- | --- |
| **æ’ä»¶åˆ—è¡¨ä¸æ˜¾ç¤º** | æ’ä»¶ç›®å½•æƒé™é—®é¢˜æˆ–config.iniæ ¼å¼é”™è¯¯ | æ£€æŸ¥ `/plugins` ç›®å½•æƒé™ï¼ŒéªŒè¯ `config.ini` æ ¼å¼ |
| **ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨å¤±è´¥** | æ’ä»¶é…ç½®é”™è¯¯æˆ–APIåœ°å€å˜æ›´ | æ£€æŸ¥æ’ä»¶ `config.ini` é…ç½®ï¼Œæ›´æ–°APIåœ°å€ |
| **æ”¯ä»˜å›è°ƒå¤±è´¥** | å•†æˆ·å›è°ƒåœ°å€ä¸å¯è¾¾ | æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼ŒæŸ¥çœ‹ pay_log è¡¨ |
| **è®¢å•çŠ¶æ€ä¸åŒæ­¥** | å¼‚æ­¥é€šçŸ¥å¤„ç†å¼‚å¸¸ | æ£€æŸ¥ notify_log è¡¨ï¼Œæ‰‹åŠ¨è¡¥å‘é€šçŸ¥ |
| **æ”¯ä»˜é€šé“å¼‚å¸¸** | é€šé“é…ç½®é”™è¯¯æˆ–é€šé“æ–¹é—®é¢˜ | æ£€æŸ¥é€šé“é…ç½®ï¼Œè”ç³»é€šé“æ–¹ |
| **ç­¾åéªŒè¯å¤±è´¥** | å•†æˆ·å¯†é’¥é”™è¯¯æˆ–å‚æ•°é¡ºåºé—®é¢˜ | æ£€æŸ¥ç­¾åç®—æ³•ï¼Œç¡®è®¤å‚æ•°é¡ºåº |
| **æ•°æ®åº“è¿æ¥å¤±è´¥** | æ•°æ®åº“é…ç½®é”™è¯¯æˆ–æœåŠ¡å¼‚å¸¸ | æ£€æŸ¥ config.phpï¼Œç¡®è®¤æ•°æ®åº“æœåŠ¡çŠ¶æ€ |

---

## 14. å¼€å‘è§„èŒƒ

### 14.1 æ’ä»¶å¼€å‘è§„èŒƒ
- **æ’ä»¶ç›®å½•å‘½å**ï¼šä½¿ç”¨è‹±æ–‡å°å†™ï¼Œå¦‚ `tm`ã€`emo`ã€`alipay` ç­‰
- **é…ç½®æ–‡ä»¶**ï¼šå¿…é¡»åŒ…å« `config.ini`ï¼Œæ ¼å¼ä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿
- **æ ¸å¿ƒæ–‡ä»¶**ï¼šå¿…é¡»åŒ…å« `submit.php`ã€`notify.php`ã€`qrcode.php`
- **å‘½åç©ºé—´**ï¼šä½¿ç”¨ `if(!defined('IN_PLUGIN'))exit();` ä¿æŠ¤
- **å¸¸é‡å®šä¹‰**ï¼šä½¿ç”¨ `TRADE_NO`ã€`PAY_PLUGIN`ã€`PAY_ROOT` ç­‰

### 14.2 æ’ä»¶é…ç½®æ–‡ä»¶è§„èŒƒ
```ini
[config]
;æ”¯ä»˜æ’ä»¶è‹±æ–‡åç§°ï¼Œéœ€å’Œç›®å½•åç§°ä¸€è‡´ï¼Œä¸èƒ½æœ‰é‡å¤
name = "tm"
;æ”¯ä»˜æ’ä»¶æ˜¾ç¤ºåç§°
showname = "TMæ”¯ä»˜"
;æ”¯ä»˜æ’ä»¶ä½œè€…
author = "tm"
;æ”¯ä»˜æ’ä»¶ä½œè€…é“¾æ¥
link = "https://www.fa599.com/"
;æ”¯ä»˜æ’ä»¶æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼Œå¤šç§æ–¹å¼ç”¨è‹±æ–‡,éš”å¼€
types = "alipay,wxpay,qqpay,webbank,yunshanpay,kaka,shuzi"
;æ”¯ä»˜æ’ä»¶è¦æ±‚ä¼ å…¥çš„å‚æ•°ä»¥åŠå‚æ•°æ˜¾ç¤ºåç§°
inputs = "appid:å•†æˆ·ID,appkey:å¯†é’¥,appurl:è‡ªå®šä¹‰é€šé“ç¼–å·,apiurl:ä¸‹å•åœ°å€,huidiaourl:å›è°ƒåœ°å€"
```

### 14.3 ä»£ç è§„èŒƒ
- ä½¿ç”¨ PSR-4 è‡ªåŠ¨åŠ è½½è§„èŒƒ
- ç±»åä½¿ç”¨å¤§é©¼å³°å‘½åæ³•
- æ–¹æ³•åä½¿ç”¨å°é©¼å³°å‘½åæ³•
- å¸¸é‡ä½¿ç”¨å…¨å¤§å†™å‘½åæ³•

### 14.4 æ•°æ®åº“è§„èŒƒ
- è¡¨åä½¿ç”¨ `pay_` å‰ç¼€
- å­—æ®µåä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- ä¸»é”®ç»Ÿä¸€ä½¿ç”¨ `id` æˆ–ä¸šåŠ¡ä¸»é”®
- æ—¶é—´å­—æ®µç»Ÿä¸€ä½¿ç”¨ `datetime` ç±»å‹

### 14.5 å®‰å…¨è§„èŒƒ
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»è¿›è¡Œè¿‡æ»¤å’ŒéªŒè¯
- æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨é¢„å¤„ç†è¯­å¥
- æ•æ„Ÿä¿¡æ¯å¿…é¡»åŠ å¯†å­˜å‚¨
- æ‰€æœ‰APIæ¥å£å¿…é¡»è¿›è¡Œç­¾åéªŒè¯
- æ’ä»¶æ–‡ä»¶å¿…é¡»è¿›è¡Œæƒé™æ£€æŸ¥

---

## 15. æ’ä»¶ç³»ç»Ÿæ·±åº¦åˆ†æ

### 15.1 æ’ä»¶ç³»ç»Ÿæ¶æ„

å¤©ä½¿æ”¯ä»˜ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯**æ’ä»¶åŒ–æ¶æ„**ï¼Œé€šè¿‡199ä¸ªæ”¯ä»˜æ’ä»¶å®ç°ä¸å„ç§ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„å¯¹æ¥ã€‚

#### æ’ä»¶ç®¡ç†æœºåˆ¶
```php
// æ’ä»¶æ‰«æå’Œæ›´æ–°é€»è¾‘
class Plugin {
    static public function updateAll(){
        global $DB;
        $DB->exec("TRUNCATE TABLE pre_plugin");
        $list = self::getList();
        foreach($list as $name){
            if($config = self::getConfig($name)){
                if($config['name']!=$name)continue;
                $DB->exec("INSERT INTO pre_plugin VALUES (:name, :showname, :author, :link, :types, :inputs, :select)", 
                    [':name'=>$config['name'], ':showname'=>$config['showname'], ':author'=>$config['author'], 
                     ':link'=>$config['link'], ':types'=>$config['types'], ':inputs'=>$config['inputs'], ':select'=>$config['select']]);
            }
        }
        return true;
    }
}
```

#### æ’ä»¶åŠ è½½æœºåˆ¶
```php
// æ’ä»¶åŠ è½½å’Œè·¯ç”±å¤„ç†
static public function load($s){
    if(preg_match('/^(.[a-zA-Z0-9]+)\/(.[a-zA-Z0-9]+)\/(.[0-9]+)\/$/',$s, $matchs)){
        $filename = PLUGIN_ROOT.$matchs[1].'/'.$matchs[2].'.php';
        if(file_exists($filename)){
            define("IN_PLUGIN", true);
            define("PAY_ROOT", PLUGIN_ROOT.$matchs[1].'/');
            define("TRADE_NO", $matchs[3]);
            define("PAY_PLUGIN", $matchs[1]);
            return $filename;
        }
    }
}
```

### 15.2 æ’ä»¶ç›®å½•ç»“æ„

```
/plugins/
â”œâ”€â”€ tm/                    # TMæ”¯ä»˜æ’ä»¶
â”‚   â”œâ”€â”€ config.ini         # æ’ä»¶é…ç½®
â”‚   â”œâ”€â”€ submit.php         # æ”¯ä»˜æäº¤
â”‚   â”œâ”€â”€ notify.php         # å¼‚æ­¥å›è°ƒ
â”‚   â”œâ”€â”€ qrcode.php         # æ”¯ä»˜é¡µé¢
â”‚   â”œâ”€â”€ return.php         # åŒæ­¥è·³è½¬
â”‚   â””â”€â”€ pay/               # æ”¯ä»˜ç±»åº“
â”‚       â”œâ”€â”€ config.php
â”‚       â”œâ”€â”€ Http.php
â”‚       â””â”€â”€ ...
â”œâ”€â”€ emo/                   # æ¶é­”æ”¯ä»˜æ’ä»¶
â”‚   â”œâ”€â”€ config.ini
â”‚   â”œâ”€â”€ submit.php
â”‚   â””â”€â”€ ...
â””â”€â”€ ...                    # å…¶ä»–197ä¸ªæ’ä»¶
```

### 15.3 æ’ä»¶å¼€å‘æµç¨‹

1. **åˆ›å»ºæ’ä»¶ç›®å½•**ï¼šåœ¨ `/plugins/` ä¸‹åˆ›å»ºæ’ä»¶ç›®å½•
2. **ç¼–å†™é…ç½®æ–‡ä»¶**ï¼šåˆ›å»º `config.ini` æ–‡ä»¶
3. **å®ç°æ ¸å¿ƒæ–¹æ³•**ï¼š
   - `submit.php` - æ”¯ä»˜æäº¤é€»è¾‘
   - `notify.php` - å¼‚æ­¥å›è°ƒå¤„ç†
   - `qrcode.php` - æ”¯ä»˜é¡µé¢å±•ç¤º
4. **åˆ·æ–°æ’ä»¶åˆ—è¡¨**ï¼šè®¿é—® `/admin/pay_plugin.php?my=refresh`

### 15.4 æ’ä»¶è°ƒç”¨æµç¨‹

```mermaid
flowchart TD
    A[å•†æˆ·æäº¤æ”¯ä»˜] --> B[submit.php]
    B --> C[Channel::submit]
    C --> D[é€‰æ‹©æ”¯ä»˜æ’ä»¶]
    D --> E[Plugin::load]
    E --> F[è°ƒç”¨æ’ä»¶submit.php]
    F --> G[ç¬¬ä¸‰æ–¹APIè°ƒç”¨]
    G --> H[è¿”å›æ”¯ä»˜é“¾æ¥]
    H --> I[å±•ç¤ºæ”¯ä»˜é¡µé¢]
    
    J[ç”¨æˆ·å®Œæˆæ”¯ä»˜] --> K[ç¬¬ä¸‰æ–¹å›è°ƒ]
    K --> L[æ’ä»¶notify.php]
    L --> M[æ›´æ–°è®¢å•çŠ¶æ€]
    M --> N[é€šçŸ¥å•†æˆ·]
```

### 15.5 æ’ä»¶é…ç½®ç¤ºä¾‹

ä»¥TMæ”¯ä»˜æ’ä»¶ä¸ºä¾‹ï¼š

```ini
[config]
name = "tm"
showname = "TMæ”¯ä»˜"
author = "tm"
link = "https://www.fa599.com/"
types = "alipay,wxpay,qqpay,webbank,yunshanpay,kaka,shuzi"
inputs = "appid:å•†æˆ·ID,appkey:å¯†é’¥,appurl:è‡ªå®šä¹‰é€šé“ç¼–å·,apiurl:ä¸‹å•åœ°å€,huidiaourl:å›è°ƒåœ°å€"
```

### 15.6 æ’ä»¶æ ¸å¿ƒæ–‡ä»¶åˆ†æ

#### submit.php - æ”¯ä»˜æäº¤
```php
<?php
if(!defined('IN_PLUGIN'))exit();
include 'function.php';
$order= $DB->getRow("SELECT * FROM pre_order WHERE trade_no = '".$trade_no."'");
echo "<script>window.location.href='/pay/tm/qrcode/{$trade_no}/?sitename={$sitename}';</script>";
?>
```

#### notify.php - å¼‚æ­¥å›è°ƒ
```php
<?php
if(!defined('IN_PLUGIN'))exit();
// å¤„ç†ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒ
$returnArray = array(
    "version" => $_REQUEST["version"],
    "partnerid" => $_REQUEST["partnerid"],
    "partnerorderid" => $_REQUEST["partnerorderid"],
    "payamount" => $_REQUEST["payamount"],
    "orderstatus" => $_REQUEST["orderstatus"],
    // ... å…¶ä»–å‚æ•°
);
// ç­¾åéªŒè¯
$sign = md5($md5str . "key=" . $md5key);
if ($sign == $_REQUEST["sign"]) {
    if ($_REQUEST["orderstatus"] == "1") {
        // æ›´æ–°è®¢å•çŠ¶æ€
        $DB->exec("update `pre_order` set `status` ='1' where `trade_no`='$out_trade_no'");
        processOrder($order);
    }
}
?>
```

#### qrcode.php - æ”¯ä»˜é¡µé¢
```php
<?php
// ç”Ÿæˆæ”¯ä»˜äºŒç»´ç å’Œé¡µé¢
$native = array(
    'version'=>"1.0",
    "partnerid" => $merId,
    "orderid" => TRADE_NO,
    "payamount" => $order['money']*100,
    "paytype" => $channel['appurl'],
    "notifyurl" => $huidiaourl."pay/tm/notify/".TRADE_NO.'/',
    "returnurl" => $huidiaourl."pay/tm/return/".TRADE_NO.'/',
);
// è°ƒç”¨ç¬¬ä¸‰æ–¹API
$submitData = Http::post($api,$native);
// å±•ç¤ºæ”¯ä»˜é¡µé¢
?>
```

---

## 16. éƒ¨ç½²è¯´æ˜

### 16.1 ç¯å¢ƒè¦æ±‚
- PHP 7.4+
- MySQL 5.7+
- Apache/Nginx
- æ”¯æŒURLé‡å†™

### 16.2 éƒ¨ç½²æ­¥éª¤
1. ä¸Šä¼ ä»£ç åˆ°Webç›®å½•
2. é…ç½®æ•°æ®åº“è¿æ¥
3. å¯¼å…¥æ•°æ®åº“ç»“æ„
4. é…ç½®WebæœåŠ¡å™¨
5. è®¾ç½®æ–‡ä»¶æƒé™
6. é…ç½®æ”¯ä»˜é€šé“
7. **åˆ·æ–°æ’ä»¶åˆ—è¡¨**ï¼šè®¿é—® `/admin/pay_plugin.php?my=refresh`

### 16.3 ä¼ªé™æ€é…ç½®
```nginx
location / {
    if (!-e $request_filename) {
        rewrite ^/(.[a-zA-Z0-9\-\_]+).html$ /index.php?mod=$1 last;
    }
    rewrite ^/pay/(.*)$ /pay.php?s=$1 last;
}
```

### 16.4 æ’ä»¶éƒ¨ç½²æ³¨æ„äº‹é¡¹
- ç¡®ä¿ `/plugins` ç›®å½•æœ‰è¯»å†™æƒé™
- æ–°æ’ä»¶éœ€è¦æŒ‰ç…§è§„èŒƒåˆ›å»º `config.ini` æ–‡ä»¶
- éƒ¨ç½²åå¿…é¡»åˆ·æ–°æ’ä»¶åˆ—è¡¨æ‰èƒ½ç”Ÿæ•ˆ
- æ£€æŸ¥æ’ä»¶æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…è¦çš„æ ¸å¿ƒæ–¹æ³•

---

**æ–‡æ¡£ç»“æŸ**

> æœ¬æ–‡æ¡£å°†æ ¹æ®ç³»ç»Ÿæ›´æ–°æŒç»­ç»´æŠ¤ï¼Œç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§ã€‚
